# Death rates by age and sex {#deathrateagesex}
```{r pb09, include=FALSE}
if(usingShiny==1){
  progress$set(detail="Death Rates by age and sex",value = 9/18)
}
```
Chart of death rates by age and sex for each year (based on mltper_1x1.csv/fltper_1x1.csv located in output directory for country)

<!-- <link rel="stylesheet" href="https://www.mortality.org/Public/sashmd.css" type="text/css"></link> -->
<!-- <script type="text/javascript" src="https://www.mortality.org/Public/slideshow.js"></script> -->
<script type="text/javascript" src="slideshow.js"></script>
<script type="text/javascript">
<!--
SLIDES = new slideshow("SLIDES");
// For a self-running slideshow you can set the delay between slides.
// 3000 = 3 seconds
SLIDES.timeout = 500;
// By default, all of the slideshow images are prefetched.
// You can set the prefetch variable if you have a large number
// of slides.
SLIDES.prefetch = 1;
// By default the slideshow will repeat when you get to the end.
// If this is set to false though, the controls do not work!!!
// SLIDES.repeat = false;
//-->

```{r generateSlides, cache=TRUE, echo=FALSE,message=FALSE,include=FALSE, eval=TRUE}

# load("parms.RData")
# library(ggplot2)
# library(data.table)

# country.code <- parms$COUNTRY
# country.name <- parms$CountryName

# mltper.path="U:\\dataLab\\UCBshare\\HMDWORKV6\\HUN\\STATS\\mltper_1x1.csv"
# mltper.path="U:/dataLab/UCBshare/HMDWORKV6/HUN/STATS/mltper_1x1.csv"
# fltper.path="U:\\dataLab\\UCBshare\\HMDWORKV6\\HUN\\STATS\\fltper_1x1.csv"

# mltper.path="/HUN/STATS/mltper_1x1.csv"

mltper.path <- file.path(parms$STATSPATH, "mltper_1x1.csv")
fltper.path <- file.path(parms$STATSPATH, "fltper_1x1.csv")

#mltper.path <- file.path("../STATS/mltper_1x1.csv")
#fltper.path <- file.path("../STATS/fltper_1x1.csv")


# read.csv(mltper.path, stringsAsFactors=FALSE, colClasses="numeric")

.line1 <- readLines(mltper.path, n=1)
if( grepl("Year", .line1)) {
      mltper <- read.csv(mltper.path, stringsAsFactors=FALSE, colClasses="numeric")
} else {
      mltper <- read.table(mltper.path, sep = ",", head=FALSE, stringsAsFactors=FALSE, colClasses="numeric")
      colnames(mltper) <- c("YearFirst", "YearLast", "Agei","Exposures", "Deaths", "mx", "ax", "qx", "px",
                               "lx", "dx", "Lx", "Tx", "ex" )
}


.line1 <- readLines(fltper.path, n=1)
if( grepl("Year", .line1)){ # file has header
    fltper <- read.csv(fltper.path, stringsAsFactors=FALSE, colClasses="numeric")
} else {
  fltper <- read.table(fltper.path, sep = ",", head=FALSE, stringsAsFactors=FALSE, colClasses="numeric")
  colnames(fltper) <- c("YearFirst", "YearLast", "Agei","Exposures", "Deaths", "mx", "ax", "qx", "px",  "lx", "dx", "Lx",
                           "Tx", "ex" )
}


mltper$Sex<- "Male"

fltper$Sex<- "Female"

ltper=rbind(fltper,mltper)

# ltper<- rbindlist(list(fltper,mltper))

availableYear<- unique(mltper$YearFirst)

# print(head(mltper))
for (i in availableYear){
  # png(paste("intpls_deathratesY",i,".png",sep=""),height=500,width=700)
  png(paste("_book/intpls_deathratesY",i,".png",sep=""), width = 8.09, height = 5, units = 'in', res = 300)

  # this.year <- ltper[ltper$YearFirst == i, ]
  this.year <- subset(ltper,subset=YearFirst==i)
  print(ggplot()+
          geom_point(data=this.year, aes(x=Agei,y=Deaths/Exposures,col=Sex))+
          geom_line(data=this.year, aes(x=Agei,y=mx,col=Sex))+
          labs(title=paste("Age specific mortality for ", parms$CountryName, " in ",i,sep=""), x="Age",y="log mortality")+
          scale_y_log10(limits = c(min(ltper$mx[ltper$mx > 0],na.rm=T),max(ltper$mx,na.rm=T)),labels = function(x) format(x, scientific = FALSE))+
          theme(legend.position=c(0.9,0.2))
        )

  dev.off()
}
```

```{r addSlidesJs, echo=FALSE, results="asis"}
template=
"s = new slide();
s.src  = \"intpls_deathratesY%1$d.png\";
s.link = \"intpls_deathratesY%1$d.png\";
s.text = \"Open link in same window\";
SLIDES.add_slide(s);"

for (i in availableYear) {
  cat(sprintf(template, i))
}

```

</script>

<!-- <style type="text/css">  -->

<!-- TD.nav { -->
<!-- text-color: #000000; -->
<!-- text-align : center; -->
<!-- font-size : 1.8em; -->
<!-- background-color : #FFFFFF; -->
<!-- color : #000000; -->
<!-- padding:0.5em; -->
<!-- } -->
<!-- TD.nav2 { -->
<!-- text-align : center; -->
<!-- font-size : 1.8em; -->
<!-- background-color : #FFFFFF; -->
<!-- border : solid; -->
<!-- border-color: #FFFFFF; -->
<!-- border-width: .1; -->
<!-- padding:0.5em; -->
<!-- } -->

<!-- </style> -->

<!-- <script> -->
<!-- ```{r print1, echo=F, results="asis"} -->
<!-- cat("function myFunction() {\ndocument.getElementById(\"demo\").innerHTML = \"Paragraph changed.\";\n}") -->
<!-- ``` -->
<!-- </script> -->

<!-- <p id="demo">A Paragraph.</p> -->

<!-- <button type="button" onclick="myFunction()">Try it</button> -->

<!-- <img src="intpls_deathratesY2017.png"> -->



<body class="center" onLoad="SLIDES.update()">

```{r projecth1env, echo=FALSE, results="asis"}
cat(sprintf("<h3>Diagnostic Charts for HMD Project - Country: %1$s (%2$s)</h3>",parms$CountryName,parms$COUNTRY))
```
<h3>Internal plausibility - Death rates by age for each year</h3>
<hr />
<table>
<tr><td colspan="2">
<img name="SLIDESIMG" src="intpls_deathratesY1950.png" alt="Slideshow image" />
</td></tr>
<tr><td class="nav">
Slide Controls:<br />
<table>
<tr>
<td class="nav2">
<a href="javascript:void(0)"
onClick="SLIDES.next();SLIDES.play();return false;">START</A>
</td>
<td class="nav2">
<a href="javascript:void(0)"
onClick="SLIDES.pause();return false;">STOP</A>
</td>
<td class="nav2">
<a href="javascript:void(0)"
onClick="SLIDES.hotlink();return false;">VIEW</A>
</td>
<td class="nav2">
<a href="javascript:void(0)"
onClick="SLIDES.previous();return false;">PREVIOUS</A>
</td>
<td class="nav2">
<a href="javascript:void(0)"
onClick="SLIDES.next();return false;">NEXT</A>
</td>
</tr>
</table></td>

<td class="nav">Delay (Seconds): <br /><table>
<tr>
<td class="nav2">
<a href="javascript:void(0)"
onClick="SLIDES.timeout=500;">0.25</A>
</td>
<td class="nav2">
<a href="javascript:void(0)"
onClick="SLIDES.timeout=500;">0.5</A>
</td>
<td class="nav2">
<a href="javascript:void(0)"
onClick="SLIDES.timeout=1000;">1</A>
</td>
<td class="nav2">
<a href="javascript:void(0)"
onClick="SLIDES.timeout=1500;">1.5</A>
</td>
<td class="nav2">
<a href="javascript:void(0)"
onClick="SLIDES.timeout=2000;">2</A>
</td>
</tr>
</table></td></tr>
<tr><td colspan="2" class="nav">
Go to year:
```{r goto_slidejs, echo=FALSE, results="asis"}
buttonYear=c(availableYear[1], availableYear[availableYear %% 5 == 0], availableYear[length(availableYear)])
if (buttonYear[1]==buttonYear[2]) {buttonYear=buttonYear[-1]}
if (buttonYear[length(buttonYear)]==buttonYear[(length(buttonYear)-1)]) {buttonYear=buttonYear[-length(buttonYear)]}
template=
"<a href=\"javascript:void(0)\"
onClick=\"SLIDES.goto_slide(%2$d);return false;\">%1$d </A>"

for (i in buttonYear) {
  cat(sprintf(template, i, match(i,availableYear)-1))
}

```

</td></tr>
</table>
<script type="text/javascript">
<!--
if (document.images) {
  SLIDES.image = document.images.SLIDESIMG;
  SLIDES.update();
  SLIDES.play();
}
//-->
</script>
<hr />
<!-- <table> -->
<!--   <tr> -->
<!--     <td class="footerl" valign="top" width="360"><address><a href="mailto:hmd@demog.berkeley.edu">Beate Danielsen: hmd@demog.berkeley.edu</a> </address></td> -->
<!--     <td class="footerr" valign="top" width="360"><em>Last Updated:<br />October 15, 2018 -->
<!--         </em><br /><a href="http://validator.w3.org/check/referer"> -->
<!--         <img height="31" alt=" [Valid XHTML 1.0!] " src="https://www.mortality.org/Public/valid-xhtml10.png"  width="88" /></a> </td> -->
<!--   </tr> -->
<!-- </table> -->
</body>
